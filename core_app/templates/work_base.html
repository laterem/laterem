{% extends 'base.html' %}
{% load laterem %}

{% block menu %}
    {% comment %} {% if student_tree %}
        {{ student_tree | safe }}
    {% else %} {% endcomment %}
        {% with tree_title="Доступные работы" %}
            {% tree "workdir" %}
        {% endwith %}
    {% comment %} {% endif %} {% endcomment %}
{% endblock %}

{% block content %}
<div id="content">
    <form method="post" id="answer-form">
        {% csrf_token %}
        {{ work_name }}
        <br/>
        {% if task.name %}
            Задача: {{task.name}}
            <br/>
        {% endif %}
        <div style="text-align: left;" id="task-area">
            {% include task.view_path %}
            <button type="submit" class="button">Проверить</button>
        </div>
        <script>
            $(document).on('submit', 'form', function(e){
                var new_data = $(this).serializeArray();
                var active_ids = $('.active').map(function(_, x) { return x.id; }).get();
                new_data.push({name: 'active_ids', value: active_ids});
    
                if ( typeof connections != "undefined" ) {
                    new_data.push({name: 'connections', value: Array.from(connections)})
                };

                $.ajax({
                    type: 'POST',
                    data: new_data,
                    async: false
                });
            });
            $(document).on('beforeunload', function(e){
                // e.preventDefault();
                console.log('catched!');
                var new_data = [];
                new_data.push({name: 'before-redirect', value: ['']});
                var active_ids = $('.active').map(function(_, x) { return x.id; }).get();
                new_data.push({name: 'active_ids', value: active_ids});
                $.ajax({
                    type: 'POST',
                    data: new_data
                });
            });
        </script>
    </form>
</div>
<aside id="left-side">
    <form method="post" style="height: 100%;">
        {% csrf_token %}
        <button type="submit" name="redirect:task{{previous_task}}" id="left-side" class="button"><span></span></button>         
    </form>
</aside>
<aside id="right-side">
    <form method="post" style="height: 100%;">
        {% csrf_token %}
        <button type="submit" name="redirect:task{{next_task}}" id="right-side" class="button"><span></span></button>         
    </form>
</aside>
{% endblock %}
{% block foot %}
    {% with button_list_items=task_list %}
        {% include "button_list.html" %}
    {% endwith %}
{% endblock %}
